@using BPSR_SharpCombat.Services
@using BPSR_SharpCombat.Models
@inject SettingsService SettingsService
@inject IJSRuntime JS
@inject ILogger<GlobalHotkeyHandler> Logger
@rendermode InteractiveServer
@implements IDisposable

@code {
    private Dictionary<string, string?> _currentHotkeys = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                SettingsService.SettingsChanged += OnSettingsChanged;
                var settings = SettingsService.GetSettings();
                await UpdateHotkeys(settings);
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "GlobalHotkeyHandler: Error initializing hotkeys");
            }
        }
    }

    private async void OnSettingsChanged(object? sender, AppSettings settings)
    {
        await UpdateHotkeys(settings);
    }

    private async Task UpdateHotkeys(AppSettings settings)
    {
        await RegisterHotkey("ToggleWindows", settings?.Hotkeys?.ToggleWindows);
        await RegisterHotkey("ToggleClickThrough", settings?.Hotkeys?.ToggleClickThrough);
    }

    private async Task RegisterHotkey(string action, string? newHotkey)
    {
        // Avoid re-registering if unchanged
        if (_currentHotkeys.TryGetValue(action, out var current) && string.Equals(current, newHotkey))
            return;

        _currentHotkeys[action] = newHotkey;
        
        try
        {
            Logger.LogInformation("GlobalHotkeyHandler: Registering hotkey for {Action}: '{Hotkey}'", action, newHotkey);
            
            await JS.InvokeVoidAsync("electron.appControl.registerGlobalShortcut", action, newHotkey);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "GlobalHotkeyHandler: Failed to register hotkey '{Hotkey}' for {Action}", newHotkey, action);
        }
    }

    public void Dispose()
    {
        SettingsService.SettingsChanged -= OnSettingsChanged;
    }
}
