@inject IJSRuntime JS
@implements IDisposable

@if (!string.IsNullOrEmpty(updateStatus) && updateStatus != "not-available" && updateStatus != "checking")
{
    <div class="update-notification @updateStatus">
        @if (updateStatus == "available")
        {
            <span>Update available! Downloading...</span>
        }
        else if (updateStatus == "downloading")
        {
            <span>Downloading update... @downloadPercent%</span>
        }
        else if (updateStatus == "downloaded")
        {
            <span>Update ready! <button @onclick="InstallUpdate">Restart & Install</button></span>
        }
        else if (updateStatus == "error")
        {
            <span>Update error: @errorMessage <button @onclick="Dismiss">x</button></span>
        }
    </div>
}

<style>
    .update-notification {
        position: fixed;
        bottom: 30px;
        right: 10px;
        background-color: #333;
        color: white;
        padding: 10px;
        border-radius: 5px;
        z-index: 9999;
        border: 1px solid #555;
        font-size: 0.8rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        animation: slideIn 0.3s ease-out;
    }
    .update-notification button {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
        margin-left: 5px;
    }
    .update-notification.error {
        background-color: #d32f2f;
    }
    @@keyframes slideIn {
        from { transform: translateY(100%); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
</style>

@code {
    private string updateStatus = "";
    private string downloadPercent = "0";
    private string errorMessage = "";
    private DotNetObjectReference<UpdateChecker>? objRef;

    protected override async Task OnInitializedAsync()
    {
        objRef = DotNetObjectReference.Create(this);
        try
        {
            // Wait a bit for JS to be ready
            await Task.Delay(1000);
            await JS.InvokeVoidAsync("registerUpdateHandler", objRef);
            
            // Check for updates manually on load if needed, but main process does it on ready
            // await JS.InvokeVoidAsync("electron.checkForUpdates");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to register update handler: {ex.Message}");
        }
    }

    [JSInvokable]
    public void OnUpdateStatus(string status, object? info)
    {
        updateStatus = status;
        
        if (status == "downloading" && info != null)
        {
            try 
            {
                var json = System.Text.Json.JsonSerializer.Serialize(info);
                using var doc = System.Text.Json.JsonDocument.Parse(json);
                if (doc.RootElement.TryGetProperty("percent", out var p))
                {
                    downloadPercent = Math.Round(p.GetDouble()).ToString();
                }
            }
            catch {}
        }
        else if (status == "error" && info != null)
        {
            errorMessage = info.ToString() ?? "Unknown error";
        }

        StateHasChanged();
    }

    private async Task InstallUpdate()
    {
        try
        {
            await JS.InvokeVoidAsync("electron.quitAndInstall");
        }
        catch { }
    }

    private void Dismiss()
    {
        updateStatus = "";
    }

    public void Dispose()
    {
        objRef?.Dispose();
    }
}
