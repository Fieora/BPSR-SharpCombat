@using BPSR_SharpCombat.Models
@using BPSR_SharpCombat.Services
@inject EncounterService EncounterService
@inject ILogger<EncounterSelector> Logger
@rendermode InteractiveServer

<select class="form-select form-select-sm" style="min-width:260px;" @bind="SelectedKey">
    <option value="current">Current Encounter</option>
    @for (int i = 0; i < _history.Count; i++)
    {
        var item = _history[i];
        var key = i.ToString();
        <option value="@key">@FormatHistoryLabel(item)</option>
    }
</select>

@code {
    private IReadOnlyList<Encounter> _history = new List<Encounter>();
    private string _selectedKey = "current";

    private string SelectedKey
    {
        get => _selectedKey;
        set
        {
            if (_selectedKey == value) return;
            _selectedKey = value;
            // UI-driven selection: map to EncounterService
            if (value == "current")
            {
                EncounterService.SelectEncounter(null);
            }
            else if (int.TryParse(value, out var idx) && idx >= 0 && idx < _history.Count)
            {
                EncounterService.SelectEncounter(_history[idx]);
            }
        }
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        _history = EncounterService.GetHistory().ToList();
        Logger.LogInformation("EncounterSelector initialized. initialHistoryCount={Count}", _history.Count);
        EncounterService.HistoryChanged += OnHistoryChanged;
        EncounterService.SelectedEncounterChanged += OnSelectedEncounterChanged;
    }

    private void OnHistoryChanged(object? sender, EventArgs e)
    {
        _history = EncounterService.GetHistory().ToList();
        Logger.LogInformation("EncounterSelector.OnHistoryChanged fired. NewHistoryCount={Count}", _history.Count);
        InvokeAsync(StateHasChanged);
    }

    private void OnSelectedEncounterChanged(object? sender, Encounter? enc)
    {
        if (enc == null)
        {
            _selectedKey = "current";
        }
        else
        {
            var idx = -1;
            for (int i = 0; i < _history.Count; i++)
            {
                if (ReferenceEquals(_history[i], enc)) { idx = i; break; }
            }
            _selectedKey = idx >= 0 ? idx.ToString() : "current";
        }
        InvokeAsync(StateHasChanged);
    }

    private string FormatHistoryLabel(Encounter e)
    {
        try
        {
            var st = e.StartTime.ToLocalTime();
            var dur = e.GetDuration();
            var total = e.GetTotalDamage();
            return $"{st:yyyy-MM-dd HH:mm:ss} — {dur:mm\\:ss} — {total:N0}";
        }
        catch
        {
            return e.StartTime.ToString();
        }
    }

    public void Dispose()
    {
        try { EncounterService.HistoryChanged -= OnHistoryChanged; } catch { }
        try { EncounterService.SelectedEncounterChanged -= OnSelectedEncounterChanged; } catch { }
    }
}
