@using BPSR_SharpCombat.Models
@using BPSR_SharpCombat.Services
@inject SettingsService SettingsService
@inject IJSRuntime JS
@rendermode InteractiveServer
@implements IDisposable

@code {
    private AppSettings _settings = new();
    private bool _initialized = false;

    protected override void OnInitialized()
    {
        _settings = SettingsService.GetSettings();
        SettingsService.SettingsChanged += OnSettingsChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_initialized)
        {
            _initialized = true;
            await ApplyBackgroundStyleAsync();
        }
    }

    private void OnSettingsChanged(object? sender, AppSettings settings)
    {
        _settings = settings;
        InvokeAsync(async () => await ApplyBackgroundStyleAsync());
    }

    private async Task ApplyBackgroundStyleAsync()
    {
        try
        {
            var appRgba = GetRgba(_settings.CombatMeter.Appearance.Background.AppRootColor, _settings.CombatMeter.Appearance.Background.AppRootOpacity);
            var titleRgba = GetRgba(_settings.CombatMeter.Appearance.Background.TitlebarColor, _settings.CombatMeter.Appearance.Background.TitlebarOpacity);
            var footerRgba = GetRgba(_settings.CombatMeter.Appearance.Background.FooterColor, _settings.CombatMeter.Appearance.Background.FooterOpacity);

            Console.WriteLine($"[BackgroundApplier] Applying app: {appRgba}, title: {titleRgba}, footer: {footerRgba}");

            await JS.InvokeVoidAsync("eval", $@"
                // Apply to .app-root to cover entire window
                var appRoots = document.querySelectorAll('.app-root');
                appRoots.forEach(function(root) {{
                    root.style.backgroundColor = '{appRgba}';
                }});
                console.log('[BackgroundApplier] Applied background to ' + appRoots.length + ' app-root elements: {appRgba}');

                // Apply to titlebar elements
                var titlebars = document.querySelectorAll('.titlebar');
                titlebars.forEach(function(tb) {{
                    tb.style.backgroundColor = '{titleRgba}';
                }});
                console.log('[BackgroundApplier] Applied titlebar to ' + titlebars.length + ' elements: {titleRgba}');

                // Apply to footer elements
                var footers = document.querySelectorAll('.app-footer');
                footers.forEach(function(ft) {{
                    ft.style.backgroundColor = '{footerRgba}';
                }});
                console.log('[BackgroundApplier] Applied footer to ' + footers.length + ' elements: {footerRgba}');
            ");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"BackgroundApplier: Failed to apply background style: {ex.Message}");
        }
    }

    private string GetRgba(string colorHex, double opacity)
    {
        if (string.IsNullOrEmpty(colorHex)) return "transparent";
        try
        {
            if (colorHex.StartsWith("#") && colorHex.Length == 7)
            {
                var r = Convert.ToInt32(colorHex.Substring(1, 2), 16);
                var g = Convert.ToInt32(colorHex.Substring(3, 2), 16);
                var b = Convert.ToInt32(colorHex.Substring(5, 2), 16);
                return $"rgba({r}, {g}, {b}, {opacity:F2})";
            }
        }
        catch { }
        return colorHex; // fallback
    }

    public void Dispose()
    {
        SettingsService.SettingsChanged -= OnSettingsChanged;
    }
}
