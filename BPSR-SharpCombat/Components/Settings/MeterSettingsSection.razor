@using BPSR_SharpCombat.Models
@using BPSR_SharpCombat.Services
@inject SettingsService SettingsService
@implements IDisposable

<div class="settings-section">
    <h6 class="settings-section-title">Meter Settings</h6>
    <div class="settings-section-content">
        <div class="mb-3">
            <label class="form-label">Meter Bar Height: <strong>@_settings.CombatMeter.Appearance.Meters.BarHeight px</strong></label>
            <div class="d-flex align-items-center" style="gap:12px;">
                <input type="range" class="form-range" min="8" max="72" step="1" value="@_settings.CombatMeter.Appearance.Meters.BarHeight" @oninput="OnMeterBarHeightChanged" />
                <input type="number" class="form-control" style="width:80px;" min="8" max="72" value="@_settings.CombatMeter.Appearance.Meters.BarHeight" @onchange="OnMeterBarHeightChangedText" />
            </div>
        </div>
    </div>
</div>

@code {
    private AppSettings _settings = new();

    protected override void OnInitialized()
    {
        _settings = SettingsService.GetSettings();
        SettingsService.SettingsChanged += OnSettingsChanged;
    }

    private void OnSettingsChanged(object? sender, AppSettings settings)
    {
        _settings = settings;
        InvokeAsync(StateHasChanged);
    }

    private void OnShowClassIconsChanged(ChangeEventArgs e)
    {
        if (e.Value is bool value)
        {
            _settings.CombatMeter.Appearance.ShowClassIcons = value;
            SettingsService.UpdateSettings(_settings);
        }
    }

    private void OnMeterBarHeightChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int value))
        {
            // clamp and apply
            value = Math.Clamp(value, 8, 72);
            _settings.CombatMeter.Appearance.Meters.BarHeight = value;
            SettingsService.UpdateMeterBarHeight(value);
        }
    }

    private void OnMeterBarHeightChangedText(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int value))
        {
            value = Math.Clamp(value, 8, 72);
            _settings.CombatMeter.Appearance.Meters.BarHeight = value;
            SettingsService.UpdateMeterBarHeight(value);
        }
    }

    public void Dispose()
    {
        SettingsService.SettingsChanged -= OnSettingsChanged;
    }
}
