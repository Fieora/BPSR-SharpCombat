@using BPSR_SharpCombat.Models
@using BPSR_SharpCombat.Services
@inject SettingsService SettingsService
@implements IDisposable

<div class="settings-section">
    <h6 class="settings-section-title">Encounter Settings</h6>
    <div class="settings-section-content">
        <div class="mb-3">
            <label class="form-label">
                Encounter Reset Timer: 
                <strong>@(_settings.CombatMeter.General.EncounterResetTimer == 0 ? "Never" : $"{_settings.CombatMeter.General.EncounterResetTimer}s")</strong>
            </label>
            <input type="range" 
                   class="form-range" 
                   min="0" 
                   max="60" 
                   step="1"
                   value="@_settings.CombatMeter.General.EncounterResetTimer"
                   @oninput="OnEncounterTimerChanged" />
            <div class="form-text">
                Time of inactivity before an encounter automatically ends. Set to 0 to never auto-end.
            </div>
        </div>
            <div class="mb-3">
                <label class="form-label">
                    Stored Encounter History: 
                    <strong>@(_settings.CombatMeter.General.MaxEncounterHistory)</strong>
                </label>
                <input type="range"
                       class="form-range"
                       min="0"
                       max="60"
                       step="1"
                       value="@_settings.CombatMeter.General.MaxEncounterHistory"
                       @oninput="OnMaxHistoryChanged" />
                <div class="form-text">
                    Maximum number of completed encounters to keep in memory (0 = disabled). Default: 10.
                </div>
            </div>
    </div>
</div>

@code {
    private AppSettings _settings = new();

    protected override void OnInitialized()
    {
        _settings = SettingsService.GetSettings();
        SettingsService.SettingsChanged += OnSettingsChanged;
    }

    private void OnSettingsChanged(object? sender, AppSettings settings)
    {
        _settings = settings;
        InvokeAsync(StateHasChanged);
    }

    private void OnEncounterTimerChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int value))
        {
            _settings.CombatMeter.General.EncounterResetTimer = value;
            SettingsService.UpdateEncounterResetTimer(value);
        }
    }

    private void OnMaxHistoryChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int value))
        {
            // clamp on service side as well, but update local view immediately
            _settings.CombatMeter.General.MaxEncounterHistory = Math.Clamp(value, 0, 60);
            SettingsService.UpdateMaxEncounterHistory(_settings.CombatMeter.General.MaxEncounterHistory);
        }
    }

    public void Dispose()
    {
        SettingsService.SettingsChanged -= OnSettingsChanged;
    }
}

