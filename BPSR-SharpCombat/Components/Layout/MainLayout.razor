@inherits LayoutComponentBase
@inject NavigationManager Nav
@inject IJSRuntime JS

@* Thin draggable title bar for repositioning the window *@
<div class="titlebar">
    <div class="titlebar-left">@Title</div>
    <div class="titlebar-right no-drag">
        <!-- future controls (close/minimize) can go here; mark no-drag so clicks work -->
        <!-- DOM-level diagnostic onclick only (remove Blazor handler for isolation). Button has an id for querying from DevTools -->
        <button id="dbg-close-btn" class="btn-close force-white" title="Close"
                onclick="(function(){ console.log('DOM: close button clicked'); try{ if(window.electron?.appControl?.closeWindow) window.electron.appControl.closeWindow(); if(window.closeAllWindows) window.closeAllWindows(); } catch(e){ console.error('DOM close call error', e); } })()">
            ✕
        </button>
    </div>
</div>

<!-- Diagnostic: confirm layout loaded in renderer console -->
<script>console.log('MainLayout loaded in renderer');</script>

<div class="overlay-root">
    @Body
</div>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">🗙</span>
</div>

@code {
    private string Title = "Damage";

    protected override void OnInitialized()
    {
        UpdateTitle(Nav.Uri);
        Nav.LocationChanged += OnLocationChanged;
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        UpdateTitle(e.Location);
        InvokeAsync(StateHasChanged);
    }

    private void UpdateTitle(string uri)
    {
        try
        {
            var basePath = new Uri(uri).AbsolutePath.ToLowerInvariant();
            if (basePath.StartsWith("/skillbreakdown")) Title = "Damage by skill";
            else Title = "Damage"; // default to damage meter
        }
        catch
        {
            Title = "Damage";
        }
    }

    public void Dispose()
    {
        Nav.LocationChanged -= OnLocationChanged;
    }

    private async Task CloseApp()
    {
        // Log immediately in renderer console to verify the C# handler is invoked
        try { await JS.InvokeVoidAsync("console.log", "renderer: CloseApp handler invoked"); } catch { }
        // Try multiple shutdown paths (best-effort):
        // 1) Prefer the global closeApp function exposed by preload.js
        // 2) Fallback to posting to the server shutdown endpoint (/api/host/shutdown)
        try
        {
            // Try the global function exposed as `closeApp` (preload.js)
            try
            {
                // First try to just close all windows (no server shutdown)
                try
                {
                    // Prefer the typed electron API if available
                    try { await JS.InvokeVoidAsync("electron.appControl.closeWindow"); return; } catch { }
                    try { await JS.InvokeVoidAsync("closeAllWindows"); return; } catch { }
                    return;
                }
                catch { }

                await JS.InvokeVoidAsync("closeApp");
                // Fire-and-forget: also attempt to close the renderer window from the page as a fallback
                try { await JS.InvokeVoidAsync("console.log", "renderer: invoked closeApp"); } catch { }
                try { await JS.InvokeVoidAsync("eval", "window.close();"); } catch { }
                return;
            }
            catch { }

            // Best-effort HTTP shutdown to the server using the app's base URI
            try
            {
                var http = new System.Net.Http.HttpClient();
                var baseUri = new Uri(Nav.BaseUri);
                var shutdownUri = new Uri(baseUri, "api/host/shutdown");
                await http.PostAsync(shutdownUri, null);
                return;
            }
            catch { }
        }
        catch
        {
            // swallow any remaining exceptions - we don't want UI errors while trying to close
        }
    }
}
